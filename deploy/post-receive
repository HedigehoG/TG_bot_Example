#!/bin/bash
# post-receive for docker-compose deployment using /opt/pybot layout
REPO_NAME=${REPO_NAME:-tg-bot}
GIT_DIR=${GIT_DIR:-/opt/pybot/conf_git/${REPO_NAME}.git}
TARGET_DIR=${TARGET_DIR:-/opt/pybot/bot_main}

echo "Deploying to ${TARGET_DIR} from ${GIT_DIR}"
mkdir -p ${TARGET_DIR}
git --work-tree=${TARGET_DIR} --git-dir=${GIT_DIR} checkout -f
cd ${TARGET_DIR} || exit

# Build/pull and restart via docker compose plugin
docker compose -f docker-compose.prod.yml pull || true
docker compose -f docker-compose.prod.yml up -d --remove-orphans

echo "Deployed (docker-compose)"
