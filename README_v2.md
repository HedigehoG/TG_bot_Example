# Шаблон для развертывания Telegram-бота

Этот репозиторий представляет собой готовый шаблон для автоматического развертывания Telegram-бота на выделенном сервере с использованием Docker и GitHub Actions.

## Возможности

- **Автоматическое развертывание**: Push в ветку `main` автоматически собирает и развертывает новую версию бота.
- **Изолированное окружение**: Бот работает в Docker-контейнере, что обеспечивает изоляцию и воспроизводимость.
- **Безопасность**:
  - Создается отдельный пользователь без пароля для деплоя.
  - Доступ к серверу осуществляется по SSH-ключу, предназначенному только для GitHub Actions.
  - Настройка SSH-сервера для повышения безопасности (отключение паролей).
- **Надежность**: Используется `docker-compose` с политикой `restart: unless-stopped` и `healthcheck` для мониторинга состояния бота.
- **Простая настройка**: Скрипт `bootstrap-server-custom.sh` выполняет всю первоначальную настройку сервера в одну команду.

## 1. Первоначальная настройка сервера

Для настройки сервера используется скрипт `bootstrap-server-custom.sh`. Он установит Docker, создаст пользователя для деплоя, сгенерирует SSH-ключи и создаст базовые конфигурационные файлы.

### Требования

- Сервер с **Ubuntu 22.04** (или другой Debian-based дистрибутив с небольшими правками в скрипте).
- Доступ к серверу с правами `root` или `sudo`.

### Выполнение

1.  Подключитесь к вашему серверу по SSH.
2.  Клонируйте этот репозиторий:
    ```bash
    git clone https://github.com/ВАШ_ЛОГИН/ВАШ_РЕПОЗИТОРИЙ.git
    cd ВАШ_РЕПОЗИТОРИЙ/deploy
    ```
3.  Запустите скрипт настройки. **Обязательно** укажите ваш репозиторий в переменной `GITHUB_REPOSITORY`.

    ```bash
    sudo GITHUB_REPOSITORY=ваш-логин/ваш-репозиторий ./bootstrap-server-custom.sh
    ```

4.  **Очень важный шаг**: Скрипт выведет в консоль секреты, которые нужно добавить в ваш GitHub-репозиторий. Скопируйте их.

    Пример вывода:
    ```
    ====================== GitHub Actions Secrets ======================
    Add the following secrets to your GitHub repository settings:
    --------------------------------------------------------------------
    SSH_HOST: 123.45.67.89
    SSH_USER: bot_main
    WORK_DIR: /home/bot_main
    ---------------------- SSH_PRIVATE_KEY (ВАЖНО!) ------------------
    Скопируйте всё, что находится между линиями...

    -----BEGIN OPENSSH PRIVATE KEY-----
    b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
    ...
    Ym90X21haW5AdWJ1bnR1AQI=
    -----END OPENSSH PRIVATE KEY-----

    ====================================================================
    ```

## 2. Настройка GitHub-репозитория

1.  Перейдите в настройки вашего репозитория на GitHub: `Settings` -> `Secrets and variables` -> `Actions`.
2.  Нажмите `New repository secret` и добавьте следующие секреты, скопировав значения из вывода скрипта:
    - `SSH_HOST`
    - `SSH_USER`
    - `SSH_PRIVATE_KEY`
    - `WORK_DIR`
3.  Добавьте еще один, самый главный секрет — токен вашего бота:
    - `BOT_TOKEN`: Скопируйте сюда токен, который вы получили от @BotFather.

## 3. Финальная конфигурация на сервере

1.  Подключитесь к серверу и откройте файл `.env`, созданный скриптом (например, `/home/bot_main/.env`).
    ```bash
    sudo nano /home/bot_main/.env
    ```
2.  Измените значение `WEBHOOK_HOST` на публичный домен или IP-адрес вашего сервера.
    ```ini
    # Пример
    WEBHOOK_HOST=https://my-cool-bot.example.com
    ```

## 4. Развертывание

Просто сделайте коммит и push в ветку `main`. GitHub Actions автоматически соберет Docker-образ, загрузит его в GitHub Container Registry (ghcr.io) и развернет на вашем сервере.

```bash
git push origin main
```

## Удаление бота и очистка сервера

Если вы хотите полностью удалить бота и все связанные с ним данные с сервера, выполните следующие шаги.

1.  Подключитесь к серверу с правами `root` или `sudo`.

2.  Остановите и удалите Docker-контейнеры, определенные в `docker-compose.yml`.
    > Имя пользователя по умолчанию совпадает с именем бота (`bot_main`). Если вы его меняли, используйте свое значение.
    ```bash
    # Замените bot_main на ваше имя пользователя, если оно отличается
    DEPLOY_USER="bot_main"
    
    # Выполняем docker-compose down от имени пользователя-деплоера
    sudo -u ${DEPLOY_USER} docker-compose -f /home/${DEPLOY_USER}/docker-compose.yml down
    ```

3.  Удалите пользователя для деплоя и его домашнюю директорию (включая все ключи, логи и конфигурации).
    ```bash
    # Флаг -r удаляет домашнюю директорию пользователя
    userdel -r ${DEPLOY_USER}
    ```

4.  (Опционально) Удалите неиспользуемые Docker-образы, чтобы освободить место.
    ```bash
    docker image prune -a
    ```

5.  Не забудьте удалить секреты (`SSH_HOST`, `SSH_USER` и т.д.) из настроек вашего GitHub-репозитория.

